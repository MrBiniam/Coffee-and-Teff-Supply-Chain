<section class="content">
  <div class="container-fluid">
    <div class="block-header">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <ul class="breadcrumb breadcrumb-style">
            <li class="breadcrumb-item">
              <h4 class="page-title">Order Detail</h4>
            </li>
            <li class="breadcrumb-item bcrumb-1">
              <a routerLink="/dashboard">
                <i class="fas fa-home"></i> Home</a>
            </li>
            <li class="breadcrumb-item bcrumb-2">
              <a href="#" onClick="return false;">Order</a>
            </li>
            <li class="breadcrumb-item active">Detail</li>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Loading indicator if order is not loaded yet -->
    <div class="col-12 text-center" *ngIf="!order?.product || !order?.product.length">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <p class="mt-2">Loading order details...</p>
    </div>
    
    <!-- Order content - only show if order.product exists -->
    <div class="order-content-container" *ngIf="order?.product && order?.product.length > 0">
      <div class="row clearfix">
        <!-- Product Section -->
        <div class="col-lg-4 col-md-12">
          <!-- Product Image Card -->
          <div class="card product-card shadow-effect" style="max-width: 90%; margin: 0 auto;">
            <div class="product-image-wrapper">
              <div class="product-image-container">
                <img [src]="'http://127.0.0.1:8000/media/Products_Pictures/' + (order.product[0].image?.split('/').pop() || order.product[0].id + '.jpg')" 
                     alt="Product Image"
                     onerror="this.src='assets/images/products/p-13.jpg'">
              </div>
            </div>
          </div>
          <!-- Product Details Card -->
          <div class="card product-details-card shadow-effect" style="max-width: 90%; margin: 20px auto;">
            <div class="header product-header">
              <h2>{{order.product[0].name}}</h2>
            </div>
            <div class="tab-pane body active product-details-body" id="about">
              <div class="product-detail-item">
                <div class="detail-label">
                  <i class="material-icons">category</i>
                  <span>Product Type</span>
                </div>
                <div class="detail-value">{{order.product[0].product_type}}</div>
              </div>
              <div class="product-detail-item">
                <div class="detail-label">
                  <i class="material-icons">attach_money</i>
                  <span>Price per Unit</span>
                </div>
                <div class="detail-value price-value">{{order.product[0].price | currency:'ETB ':'symbol':'1.2-2'}}</div>
              </div>
              <div class="product-detail-item">  
                <div class="detail-label">
                  <i class="material-icons">shopping_cart</i>
                  <span>Quantity</span>
                </div>
                <div class="detail-value">{{order.quantity}}</div>
              </div>
              <div class="product-detail-item total-price">
                <div class="detail-label">
                  <i class="material-icons">calculate</i>
                  <span>Total Price</span>
                </div>
                <div class="detail-value total-value">{{order.product[0].price * +order.quantity | currency:'ETB ':'symbol':'1.2-2'}}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Description and User Profiles Section -->
        <div class="col-lg-8 col-md-12">
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" aria-expanded="true">
              <div class="row clearfix">
                <!-- Product Description -->
                <div class="col-lg-12 col-md-12 col-sm-12">
                  <div class="card project_widget description-card shadow-effect">
                    <div class="header description-header">
                      <h5><i class="material-icons">description</i> About Product</h5>
                    </div>
                    <div class="body description-body">
                      <p class="product-description" style="font-size: 1rem; color: #333; line-height: 1.6; white-space: pre-line;">{{order.product[0].description || 'Our Jimma Bunna is a premium Ethiopian coffee, sourced from the rich, fertile highlands of Jimma. Known for its smooth, full-bodied flavor, this coffee offers a perfect balance of floral, fruity, and spicy notes with a hint of natural sweetness. Handpicked and roasted to perfection, it brings the authentic taste of Ethiopia\'s coffee heritage directly to your cup. Enjoy the bold, vibrant flavor and support sustainable farming practices with every sip!'}}</p>
                    </div>
                  </div>
                </div>
                
                <!-- User Profiles -->
                <div class="col-lg-12 col-md-12 col-sm-12">
                  <div class="card profiles-card shadow-effect">
                    <div class="row profiles-row">
                      <!-- Buyer Info Section (NEW) -->
                      <div class="col-md-6">
                        <div class="dashboard-section buyer-dashboard">
                          <div class="dashboard-header" style="background: linear-gradient(120deg, #8e24aa, #ba68c8); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            <h5><i class="material-icons">person</i> About You (Buyer)</h5>
                          </div>
                          <div class="profile-container">
                            <div class="profile-image-container">
                              <img [src]="'http://127.0.0.1:8000/media/profile_images/' + (driver?.profile_image?.split('/').pop() || driver?.id + '.jpg')" 
                                  class="profile-image" alt="Driver Profile"
                                  onerror="this.src='assets/images/user/user1.jpg'">
                            </div>
                            <div class="profile-header buyer-profile-header text-center">
                              <div class="payment-method" style="color: #fff; font-size: 1.2rem; background: linear-gradient(120deg, #8e24aa, #ba68c8); padding: 20px 30px; border-radius: 10px; display: block; margin: 15px auto; box-shadow: 0 4px 8px rgba(0,0,0,0.25); width: 90%; max-width: 400px;">
                                <div style="font-weight: 700; margin-bottom: 8px; font-size: 1.4rem;">{{driver?.username}}</div>
                                <div>{{driver?.payment_method}}</div>
                              </div>
                            </div>
                            <div class="profile-details text-center">
                              <p class="address" style="color: #555; text-align: center; display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                                <i class="material-icons" style="color: #ba68c8; margin-right: 5px;">location_on</i>
                                <span>{{driver?.address}}</span>
                              </p>
                              <p class="phone" style="color: #555; text-align: center; display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                                <i class="material-icons" style="color: #ba68c8; margin-right: 5px;">phone</i>
                                <span>{{driver?.phone_number}}</span>
                              </p>
                              <p *ngIf="driver?.driver_profile?.car_model" class="address" style="color: #555; text-align: center; display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                                <i class="material-icons" style="color: #ba68c8; margin-right: 5px;">directions_car</i>
                                <span>{{driver?.driver_profile?.car_model}}</span>
                              </p>
                            </div>
                            <div class="profile-actions">
                              <button class="btn chat-button" (click)="goToChat(driver?.username)">
                                <i class="material-icons">chat</i> Chat Now
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Seller Profile -->
                      <div class="col-md-6">
                        <div class="dashboard-section seller-dashboard">
                          <div class="dashboard-header" style="background: linear-gradient(120deg, #f9a825, #ffd54f); color: #212121; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                            <h5><i class="material-icons">store</i> About The Seller</h5>
                          </div>
                          <div class="profile-container">
                            <div class="profile-image-container">
                              <img [src]="'http://127.0.0.1:8000/media/profile_images/' + (user?.profile_image?.split('/').pop() || user?.id + '.jpg')" 
                                  class="profile-image" alt="Seller Profile"
                                  onerror="this.src='assets/images/user/user1.jpg'">
                            </div>
                            <div class="profile-header seller-profile-header text-center">
                              <div class="payment-method" style="color: #212121; font-size: 1.2rem; background: linear-gradient(120deg, #f9a825, #ffd54f); padding: 20px 30px; border-radius: 10px; display: block; margin: 15px auto; box-shadow: 0 4px 8px rgba(0,0,0,0.25); width: 90%; max-width: 400px;">
                                <div style="font-weight: 700; margin-bottom: 8px; font-size: 1.4rem;">{{user?.username}}</div>
                                <div>{{user?.payment_method}}</div>
                              </div>
                            </div>
                            <div class="profile-details text-center">
                              <p class="address" style="color: #555; text-align: center; display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                                <i class="material-icons" style="color: #ffc107; margin-right: 5px;">location_on</i>
                                <span>{{user?.address}}</span>
                              </p>
                              <p class="phone" style="color: #555; text-align: center; display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                                <i class="material-icons" style="color: #ffc107; margin-right: 5px;">phone</i>
                                <span>{{user?.phone_number}}</span>
                              </p>
                            </div>
                            <div class="profile-actions">
                              <button class="btn chat-button" (click)="goToChat(user?.username)">
                                <i class="material-icons">chat</i> Chat Now
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Customer Review -->
                <div class="col-lg-12 col-sm-12 col-md-12" *ngIf="rate?.length">
                  <div class="card review-card shadow-effect">
                    <div class="header review-header">
                      <h2>
                        <i class="material-icons">star</i> <strong>Customer</strong> Reviews
                      </h2>
                    </div>
                    <div class="body review-body">
                      <div class="review-block">
                        <div class="review-item" *ngFor="let rat of rate">
                          <div class="review-img">
                            <img src="assets/images/user/user1.jpg" alt="">
                          </div>
                          <div class="review-content">
                            <h6 class="reviewer-name">{{rat.sender}}
                              <span class="review-date">{{rat.timestamp | date: 'MM/dd/yyyy'}}</span>
                            </h6>
                            <div class="rating-stars">
                              <i class="material-icons" *ngFor="let star of stars; let i = index"
                                [ngClass]="{'golden-star': (i + 1) <= +(rat.rating_value)}">
                                star
                              </i>
                            </div>
                            <p class="review-text">{{rat.comment}}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Empty state if no order details found -->
    <div class="row" *ngIf="!isLoading && (!order || !order.id || !order.product)">
      <div class="col-md-12">
        <div class="card">
          <div class="card-body text-center p-5">
            <img src="assets/images/user/error.svg" alt="Order Not Found" style="max-width: 200px; margin-bottom: 20px;" onerror="this.src='assets/images/user/user1.jpg'">
            <h4>Order Not Found</h4>
            <p class="text-muted">The order details you are looking for could not be found or are incomplete.</p>
            <button mat-raised-button color="primary" (click)="goBack()">Go Back</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>