<section class="content">
  <div class="container-fluid">
    <div class="block-header">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <ul class="breadcrumb breadcrumb-style ">
            <li class="breadcrumb-item">
              <h4 class="page-title">Orders</h4>
            </li>
            <li class="breadcrumb-item bcrumb-1">
              <a routerLink="/doctor/dashboard">
                <i class="fas fa-home"></i> Home</a>
            </li>
            <li class="breadcrumb-item active">Assigned Orders</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card">
          <div class="body">
            <div class="row">
              <div class="col-md-12">
                <h4 class="mb-3">Active Deliveries</h4>
              </div>
            </div>
            <div class="row" *ngIf="orders.length === 0">
              <div class="col-md-12 text-center p-4">
                <div class="alert alert-info">
                  <i class="material-icons">info</i>
                  <p class="mb-0">You don't have any active delivery assignments right now.</p>
                </div>
              </div>
            </div>
            <div class="row" *ngFor="let order of orders">
              <div class="col-12">
                <div class="card p-3">
                  <!-- Product name aligned with content -->
                  <div class="row mb-2">
                    <div class="col-12">
                      <h2 style="font-size: 28px; font-weight: 600; color: #3f51b5; margin-bottom: 10px; text-align: left; padding-left: 15px;">{{order.product[0].name}}</h2>
                    </div>
                  </div>
                  
                  <div class="row align-items-center">
                    <!-- Product image - slightly bigger -->
                    <div class="col-12 col-md-4 mb-3">
                      <div style="width: 210px; margin-left: 15px;">
                        <img class="product-image shadow" 
                             style="width: 100%; height: 175px; object-fit: cover; border-radius: 8px; border: 2px solid #eaeaea;" 
                             src="http://127.0.0.1:8000/{{order.product[0].image?.includes('http://127.0.0.1:8000/') ? order.product[0].image.substring(21) : order.product[0].image}}"
                             alt="{{order.product[0].name}}"
                             (error)="handleImageError($event)">
                      </div>
                    </div>
                    
                    <!-- Product details -->
                    <div class="col-md-5 mb-3 pl-0">
                      <div class="d-flex flex-column justify-content-start user-profile w-100">
                        <div class="mb-2"><strong>Type:</strong> {{order.product[0].product_type}}</div>
                        <div class="mb-2"><strong>Quantity:</strong> {{order.quantity}}</div>
                        <div class="mb-2"><strong>Price per Unit:</strong> {{order.product[0].price}}</div>
                        <div class="mb-2"><strong>Total Price:</strong> {{(+order.quantity) * order.product[0].price || order.product[0].price}}</div>
                        <div class="mb-2"><strong>Order Date:</strong> {{order.order_date | date: 'MM/dd/yyyy'}}</div>
                      </div>
                    </div>
                    
                    <div class="col-md-3 mb-3 d-flex flex-column align-items-end justify-content-center">
                      <!-- Enhanced buttons -->
                      <div class="w-100">
                        <button mat-raised-button color="primary" (click)="orderDetail(order.id)" class="mb-3"
                                style="width: 100%; font-size: 16px; padding: 12px; border-radius: 30px; font-weight: 600; 
                                box-shadow: 0 4px 8px rgba(63, 81, 181, 0.3); 
                                background: linear-gradient(45deg, #3f51b5, #5c6bc0); 
                                border: none; color: white; transition: all 0.3s ease;">
                          <i class="fas fa-comments mr-2"></i> Hey Let's Chat
                        </button>
                        <button mat-raised-button color="accent" (click)="shipOrder(order)" class="mt-1"
                                style="width: 100%; font-size: 16px; padding: 12px; border-radius: 30px; font-weight: 600; 
                                box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3); 
                                background: linear-gradient(45deg, #ff9800, #ffb74d); 
                                border: none; color: white; transition: all 0.3s ease;">
                          <i class="fas fa-shipping-fast mr-2"></i> Ship Order
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- COMPLETED ORDERS SECTION -->
            <div class="row mt-5">
              <div class="col-md-12">
                <h4 class="mb-3">Completed Deliveries</h4>
              </div>
            </div>
            <div class="row" *ngIf="completedOrders.length === 0">
              <div class="col-md-12 text-center p-4">
                <div class="alert alert-light">
                  <i class="material-icons">history</i>
                  <p class="mb-0">You don't have any completed deliveries yet.</p>
                </div>
              </div>
            </div>
            <div class="row" *ngFor="let order of completedOrders">
              <div class="col-12">
                <div class="card p-3" style="background-color: #f9f9f9; opacity: 0.9;">
                  <div class="row">
                    <!-- LEFT SIDE: Product image and Order Details -->
                    <div class="col-md-6">
                      <div class="row">
                        <!-- Product image -->
                        <div class="col-12 col-md-5 mb-0">
                          <div style="text-align: center; padding: 10px;">
                            <img class="product-image shadow" 
                                style="width: 180px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #eaeaea; filter: grayscale(0.3);" 
                                src="http://127.0.0.1:8000/{{order.product[0].image?.includes('http://127.0.0.1:8000/') ? order.product[0].image.substring(21) : order.product[0].image}}"
                                alt="{{order.product[0].name}}"
                                (error)="handleImageError($event)">
                          </div>
                        </div>
                        
                        <!-- Order details -->
                        <div class="col-md-7 mb-0">
                          <div class="doc-card-title">
                            <h4 style="font-size: 22px; color: #757575; font-weight: 600; margin-bottom: 15px;">{{order.product[0].name}}</h4>
                          </div>
                          
                          <!-- Order details with consistent formatting -->
                          <div class="order-details">
                            <div class="mb-2"><strong>Type:</strong> {{order.product[0].product_type}}</div>
                            <div class="mb-2"><strong>Quantity:</strong> {{order.quantity}}</div>
                            <div class="mb-2"><strong>Price per Unit:</strong> {{order.product[0].price}}</div>
                            <div class="mb-2"><strong>Total Price:</strong> {{(+order.quantity) * order.product[0].price || order.product[0].price}}</div>
                            <div class="mb-2"><strong>Order Date:</strong> {{order.order_date | date: 'MM/dd/yyyy'}}</div>
                            <div class="mb-2" *ngIf="order.shipped_date"><strong>Shipped Date:</strong> {{order.shipped_date | date: 'MM/dd/yyyy'}}</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- RIGHT SIDE: Stakeholders, Vertical Line, and Delivery Status -->
                    <div class="col-md-6">
                      <div class="row">
                        <!-- Stakeholders - Vertical Layout -->
                        <div class="col-md-4 mb-0 d-flex align-items-center">
                          <div class="stakeholder-container" style="display: flex; flex-direction: column; height: 100%; justify-content: space-between; width: 100%;">
                            
                            <!-- Seller Information - Top -->
                            <div class="stakeholder-card text-center mb-3">
                              <div class="stakeholder-circle">
                                <div style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9E9E9E; margin: 0 auto; overflow: hidden; background-color: #EEEEEE; display: flex; align-items: center; justify-content: center;">
                                  <img *ngIf="order.seller_username" 
                                      [src]="getUserImageUrl(order.seller_username, 'seller')"
                                      style="width: 100%; height: 100%; object-fit: cover; filter: grayscale(0.5);"
                                      (error)="handleImageError($event)">
                                  <i class="fas fa-store" style="font-size: 30px; color: #9E9E9E; display: none;"></i>
                                </div>
                                <h6 class="mt-1" style="font-size: 12px; margin-bottom: 0;">Seller</h6>
                                <p style="font-size: 11px; margin-bottom: 0;">{{ order.seller_username || 'Unknown' }}</p>
                              </div>
                            </div>
                            
                            <!-- Driver Information - Middle -->
                            <div class="stakeholder-card text-center mb-3">
                              <div class="stakeholder-circle">
                                <div style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9E9E9E; margin: 0 auto; overflow: hidden; background-color: #EEEEEE; display: flex; align-items: center; justify-content: center;">
                                  <img *ngIf="order.driver_username" 
                                      [src]="getUserImageUrl(order.driver_username, 'driver')"
                                      style="width: 100%; height: 100%; object-fit: cover; filter: grayscale(0.5);"
                                      (error)="handleImageError($event)">
                                  <i class="fas fa-truck" style="font-size: 30px; color: #9E9E9E; display: none;"></i>
                                </div>
                                <h6 class="mt-1" style="font-size: 12px; margin-bottom: 0;">Driver</h6>
                                <p style="font-size: 11px; margin-bottom: 0;">{{ order.driver_username || 'You' }}</p>
                              </div>
                            </div>
                            
                            <!-- Buyer Information - Bottom -->
                            <div class="stakeholder-card text-center">
                              <div class="stakeholder-circle">
                                <div style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #9E9E9E; margin: 0 auto; overflow: hidden; background-color: #EEEEEE; display: flex; align-items: center; justify-content: center;">
                                  <img *ngIf="order.buyer_username" 
                                      [src]="getUserImageUrl(order.buyer_username, 'buyer')"
                                      style="width: 100%; height: 100%; object-fit: cover; filter: grayscale(0.5);"
                                      (error)="handleImageError($event)">
                                  <i class="fas fa-user" style="font-size: 30px; color: #9E9E9E; display: none;"></i>
                                </div>
                                <h6 class="mt-1" style="font-size: 12px; margin-bottom: 0;">Buyer</h6>
                                <p style="font-size: 11px; margin-bottom: 0;">{{ order.buyer_username || 'Customer' }}</p>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Vertical Line -->
                        <div class="col-md-1 d-flex justify-content-center">
                          <div style="width: 2px; height: 90%; background-color: #e0e0e0; margin: auto;"></div>
                        </div>
                        
                        <!-- Delivery Status -->
                        <div class="col-md-7 d-flex align-items-center">
                          <div class="delivery-success p-3" style="background: linear-gradient(120deg, #f5f5f5, #e0e0e0); border-radius: 12px; border-left: 5px solid #9E9E9E; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); width: 100%;">
                            <div class="text-center">
                              <i class="fas fa-check-circle" style="font-size: 32px; color: #757575; margin-bottom: 10px;"></i>
                              <h5 style="color: #757575; font-weight: 700; font-size: 20px; margin-bottom: 8px;">Successfully Delivered</h5>
                              <div style="width: 50px; height: 4px; background: #9E9E9E; margin: 0 auto 15px auto; border-radius: 2px;"></div>
                              <p style="color: #757575; font-size: 14px;">This order has been completed and delivered to the buyer.</p>
                              
                              <button mat-stroked-button (click)="orderDetail(order.id)" 
                                      style="border: 2px solid #757575; color: #757575; margin-top: 10px;">
                                <i class="fas fa-search mr-2"></i> View Details
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
